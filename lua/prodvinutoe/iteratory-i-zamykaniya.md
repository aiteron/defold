---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Итераторы и замыкания

## Замыкания

замыкание — это функция, которая обращается к одной или нескольким локальным переменным из охватывающего ее окружения



## Итераторы

Итератор (iterator) — это любая конструкция, которая позволяет вам перебирать элементы коллекции. В Lua мы обычно представляем итераторы при помощи функций: каждый раз, когда мы вызываем функцию, она возвращает «следующий» элемент из коллекции.

Любой итератор должен где-то хранить свое состояние между последовательными вызовами, чтобы знать, где он находится и как себя вести с этого места. Замыкания предоставляют великолепный механизм для этой задачи. Внешние переменные замыкания хранят свои значения между последовательными вызовами, позволяя тем самым замыканию помнить, где оно находится при переборе элементов. Разумеется, для создания нового замыкания мы также должны создать его нелокальные переменные. Поэтому конструкция замыкания обычно включает в себя две функции: само замыкание и фабрику — функцию, которая создает замыкание вместе с окружающими ее переменными.

Рассмотрим пример - итератор для списка, который возвращает значение каждого элемента:

```lua
function values(t)
    local i = 0
    return function() i = i + 1; return t[i] end
end
```

В этом примере values - это фабрика. Каждый раз, когда мы вызываем эту фабрику, она создает новое замыкание (сам итератор). Это замыкание хранит свое состояние в своих внешних переменных t и i.Каждый раз, когда мы вызываем этот итератор, он возвращает следующее значение из списка t. После последнего элемента итератор вернет nil, что означает конец итерации.

Чаще всего итераторы используются в общем for:

```lua
t = {10, 20, 30}
for element in values(t) do
    print(element)
end
```

for хранит внутри итерирующую функцию (полученную от фабрики), вызывает итератор для каждой новой итерации цикла и останавливает цикл, когда итератор возвращает nil.

### Семантика общего for

Единственным недостатком ранее рассмотренных итераторов является то, что нам необходимо создавать новое замыкание для инициализации каждого нового цикла. Однако мы можем обойтись без замыкания используя общий for для хранения состояния итерации.

На самом деле общий for хранит три значения: итерирующую функцию, инвариантное (неизменяющееся) состояние и управляющую переменную.
